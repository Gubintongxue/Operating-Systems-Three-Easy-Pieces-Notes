### 20.1 简单的解决方案：更大的页

解决页表过大的一个简单方法是增大页面的大小。通过增大页的大小，页表中的页数减少，从而显著减小页表的大小。

#### 关键问题：如何让页表更小？

假设我们有一个 32 位地址空间，其中页大小为 4KB。这样，我们需要 20 位的虚拟页号（VPN），再加上 12 位的页内偏移量。每个页表项的大小为 4 字节，则页表中总共有 220 个项，因此页表的总大小为 4MB。这个大小对于每个进程来说非常庞大，尤其是当有多个进程同时运行时。

如果我们将页面大小增加到 16KB，虚拟页号减少到 18 位。页表中的项数因此减少为 218，而页表的总大小则变为 1MB，仅为原来的四分之一。这种方式显著减小了页表所需的内存。

#### 多种页大小的使用

许多现代处理器架构（如 MIPS、SPARC、x86-64）支持多种页大小。通常情况下，小页面（4KB 或 8KB）用于大多数操作，但对于某些特定应用（如数据库管理系统），可以使用更大的页面（如 4MB）。大页面可以减少 TLB 的压力，因为大页面意味着需要的 TLB 项更少。

尽管使用更大的页面可以减少页表的大小和 TLB 的负载，但它也带来了内部碎片的问题。即使只有部分页面被使用，整个页面的空间也会被分配，这可能导致内存的浪费。因此，大多数系统在常见情况下仍使用较小的页面大小，如 4KB 或 8KB。

### 20.2 混合方法：分页和分段

在解决复杂问题时，结合不同的方法往往能带来更好的结果。分页和分段的结合就是一种杂合方法，旨在减少页表的内存开销。

#### 分页和分段结合的原因

通过回顾线性页表的使用情况，我们可以看到，典型的地址空间往往会有很大一部分未被使用。比如，一个 16KB 地址空间，使用 1KB 的页面，那么就会有许多页表项是无效的。如果将这种情况扩展到 32 位地址空间，未使用的页表项数量会变得非常巨大，造成极大的内存浪费。

#### 杂合方案的实现

杂合方法的关键思想是将分页和分段结合起来。我们不再为整个进程的地址空间提供一个单一的页表，而是为每个逻辑段（如代码段、堆段、栈段）分别提供页表。每个段的页表大小与该段的实际使用情况相匹配，从而减少内存浪费。

在这种方案中，每个段都有自己的基址寄存器和界限寄存器。基址寄存器指向该段的页表的物理地址，界限寄存器则指示该页表的结尾。在进行地址转换时，系统会根据段标识符（SN）选择相应的基址寄存器，结合虚拟页号（VPN）计算页表项的地址。

通过这种方法，我们可以显著减少页表的大小，同时保留分页和分段的优点。然而，这种方法并非没有缺点。由于仍然使用了分段，杂合方案可能会导致外部碎片问题，而且对于那些具有大而稀疏地址空间的应用程序，页表仍可能会浪费大量空间。

### 20.3 多级页表

多级页表（multi-level page table）是一种有效地解决页表空间浪费问题的方法。其基本思想是通过将页表分层组织成类似树的结构，使得仅为有效的虚拟地址分配页表空间，从而减少内存的消耗。多级页表在许多现代系统中得到了应用，例如 x86 架构。

#### 多级页表的结构

在多级页表中，页表被分割成多个页面，每个页面由页目录（page directory）管理。如果某个页表页面中的所有页表项（PTE）都是无效的，那么整个页表页面就不会被分配内存。页目录则用于记录哪些页表页面是有效的，并指向它们在内存中的位置。

图 20.2 展示了一个多级页表的示例。左侧显示了经典的线性页表，其中即使地址空间中的大部分中间区域无效，仍然需要为这些区域分配页表空间。右侧则是一个多级页表。可以看到，只有页表的两页被标记为有效，因此只需要为这两页分配内存。

在一个简单的两级页表中，页目录为每页页表包含一项（PDE，Page Directory Entry）。PDE 包含有效位（valid bit）和页帧号（page frame number, PFN）。如果 PDE 的有效位为 1，则表示该 PDE 指向的页表页面中至少有一个有效的 PTE；如果有效位为 0，则该 PDE 无效，页表页面不存在。

#### 多级页表的优势

1. **节省内存**：多级页表的主要优势在于其内存使用量与实际使用的地址空间成比例。对于稀疏的地址空间，多级页表只需要为那些实际使用的页面分配页表空间，而不会浪费内存。
2. **易于管理**：通过将页表的每一部分组织成页面大小的单位，操作系统可以更加容易地管理页表。例如，当需要增加或删除页表项时，操作系统只需对整个页面进行操作，而无需处理连续的大块内存。
3. **减少碎片**：多级页表避免了线性页表中必须分配连续大块内存的需求。通过使用页目录来分层管理页表项，多级页表允许页表页面分散在物理内存的各个位置，减少了内存碎片。

#### 多级页表的劣势

然而，多级页表也有其缺点。首先，多级页表的实现比线性页表更为复杂。无论是硬件还是操作系统都需要处理多级页表的查找操作，这增加了系统的复杂性。其次，在 TLB 未命中的情况下，多级页表的地址转换需要更多的内存访问（例如，两次访问，一次用于页目录，一次用于页表项），这会导致性能上的开销。

#### 示例：构建多级页表

为了更好地理解多级页表的工作原理，我们来看一个具体的例子。假设有一个大小为 16KB 的地址空间，其中包含 64 字节的页面。这个地址空间有一个 8 位的虚拟页号（VPN）和 6 位的偏移量（offset）。即使这个地址空间只有一小部分被使用，线性页表仍然会有 256 个项（2^8），即占用 1KB 的内存。

我们可以将这个地址空间的页表分为 16 个页面，每个页面包含 16 个 PTE。接下来，我们使用 VPN 的前 4 位来索引页目录（Page Directory），找到对应的页表页面。如果该页表页面存在，我们再用 VPN 的后 4 位来索引页表，找到对应的 PTE，最终得到物理地址。

例如，假设我们有一个地址空间，其中：

- VPN 0 和 1 用于代码段，
- VPN 4 和 5 用于堆，
- VPN 254 和 255 用于栈。

在多级页表中，我们首先查找页目录，找到指向代码段、堆和栈的页表页面。然后再从这些页表页面中找到对应的 PTE，最终得到物理地址。通过这种方式，我们可以避免为未使用的地址空间分配内存。

#### 多级页表的扩展

在某些情况下，两级页表可能还不够用。对于更大的地址空间，可能需要使用更多级的页表。例如，假设我们有一个 30 位的虚拟地址空间和 512 字节的页面。这时，我们可能需要使用三级或更多级的页表来管理地址转换。

每增加一级页表，都会在地址转换过程中增加一次内存访问。但与此同时，每一级页表都会减少内存的占用，从而达到节省内存的目的。

### 地址转换过程

多级页表的地址转换过程如下：

1. **TLB 查找**：首先，硬件会检查 TLB 中是否存在该虚拟地址的转换映射。如果命中，直接得到物理地址。
2. **页目录查找**：如果 TLB 未命中，硬件将使用虚拟地址的前几位索引页目录，找到对应的页目录项。
3. **页表查找**：然后，硬件使用虚拟地址的下一部分索引页表，找到对应的页表项（PTE）。
4. **物理地址生成**：最后，硬件根据 PTE 生成物理地址，并进行内存访问。

通过这种方式，多级页表在节省内存的同时，实现了高效的地址转换。

### 20.4 反向页表

在反向页表（Inverted Page Table, IPT）中，页表的设计变得更加极端，以实现更大的空间节省。与传统的页表设计不同，反向页表仅维护一个系统范围内的全局页表，而不是为每个进程都分配一个独立的页表。每个页表项对应一个物理页，并且包含使用该物理页的进程标识符（PID）以及虚拟页号（VPN）。

#### 反向页表的工作原理

在传统的页表中，页表项通过虚拟页号索引，可以快速定位对应的物理页。而在反向页表中，由于每个页表项代表一个物理页，需要通过扫描页表来找到与给定虚拟页匹配的物理页，这就引入了效率问题。

为了解决这个问题，反向页表通常会结合哈希表（hash table）来加速查找过程。具体来说，每次需要执行地址转换时，系统会使用虚拟页号和进程标识符作为哈希函数的输入，从而在反向页表中定位到可能的物理页。通过这种方式，哈希表减少了线性扫描的成本，提高了查找速度。

PowerPC 体系结构就是一个使用反向页表的典型例子。它通过这种设计在系统级别实现了更高效的内存管理。

#### 反向页表的优缺点

**优点**：

- **节省空间**：反向页表显著减少了页表的内存开销，因为系统只需要维护一个全局页表，而不是为每个进程维护独立的页表。
- **简化管理**：通过集中管理物理页，操作系统可以更容易地进行全局内存管理和页面置换。

**缺点**：

- **查找复杂度**：由于反向页表不再直接通过虚拟页号进行索引，查找过程变得更加复杂，需要借助哈希表等辅助结构来提高查找效率。
- **哈希冲突**：在使用哈希表时，如果哈希函数设计不当，可能会引发大量冲突，进一步降低查找效率。

### 20.5 将页表交换到磁盘

在内存有限的系统中，即使应用了多级页表或反向页表等优化技术，页表仍然可能过大，无法完全存储在物理内存中。在这种情况下，操作系统可以将页表的部分内容交换（swap）到磁盘中。这样做允许操作系统腾出内存空间给其他更紧急的任务，同时确保页表不会成为内存消耗的瓶颈。

#### 页表的交换机制

在需要将页表的一部分交换到磁盘时，操作系统会将页表存储在内核虚拟内存中，并在物理内存中为其分配一个较小的缓存区域。未被缓存的页表部分将被换出到磁盘，当系统需要访问这些部分时，操作系统会将其换回内存中。

这种机制的工作原理类似于对进程页面的换出和换入，只不过这里的对象是页表项。当系统内存紧张时，这种机制能够显著减少页表的内存占用，从而将更多的内存留给实际的用户进程。

在实际操作系统中，例如 VAX/VMS 系统中，就采用了这种技术，以处理大规模的虚拟内存需求。通过将页表交换到磁盘，操作系统能够在内存管理方面更灵活应对多任务负载。

### 20.6 小结

在本章中，我们探讨了几种减少页表内存占用的策略，从简单的线性页表到更复杂的多级页表和反向页表。这些策略反映了时间与空间的权衡，不同系统和应用场景下，选择不同的数据结构来管理内存页表是非常重要的。

- **多级页表**：通过将线性页表分成多级结构，有效减少了内存使用，适合大多数现代系统。
- **反向页表**：进一步极端的空间节省方法，适用于特定架构，如 PowerPC，但需要更复杂的查找机制。
- **页表交换到磁盘**：当内存压力过大时，允许将部分页表换出到磁盘，进一步降低内存占用。

总的来说，页表设计中涉及的复杂性和性能权衡，依赖于系统的具体需求和硬件支持。操作系统开发人员需要根据应用场景选择合适的页表结构，确保系统在内存管理方面的高效性与可扩展性。