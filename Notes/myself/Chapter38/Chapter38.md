### 38.1 接口和 RAID 内部

RAID（廉价冗余磁盘阵列）系统对于文件系统和其他客户端应用程序而言，看起来像一个大型、快速且可靠的磁盘。文件系统发出逻辑 I/O 请求，RAID 系统则需要计算请求应访问的磁盘，并执行相应的物理 I/O 操作。

RAID 的内部结构非常复杂，通常由一个微控制器、易失性存储器（如 DRAM）、非易失性存储器（用于安全缓冲写入操作）以及可能的专用逻辑电路组成。RAID 系统通过标准接口（如 SCSI 或 SATA）连接到主机，其内部运作类似于一个专用计算机系统，运行特定的固件来管理磁盘操作。

### 38.2 故障模型

RAID 的设计旨在处理和恢复某些类型的磁盘故障。最简单的故障模型称为故障—停止（fail-stop）模型，在这种模型下，磁盘只有两种状态：工作状态或故障状态。工作状态下，所有块都可以正常读写，而故障状态则意味着磁盘永久丢失。

在故障—停止模型中，RAID 系统能够轻松检测到磁盘的故障，这一假设对于实现 RAID 的冗余设计非常重要。然而，该模型并未考虑更复杂的无声故障（如磁盘损坏）或潜在的扇区错误。

### 38.3 如何评估 RAID

在评估不同的 RAID 设计时，主要从以下三个方面进行考虑：

1. **容量（Capacity）**：给定一组 N 个磁盘，RAID 的有效容量是多少？在没有冗余的情况下，容量就是 N。但在存在冗余时（如每个块有两个副本），有效容量会减少到 N/2。不同的 RAID 级别会在容量上表现出不同的结果。
2. **可靠性（Reliability）**：不同的 RAID 设计能够承受多少个磁盘故障？此评估基于假设的故障模型，在该模型中假设整个磁盘可能会发生故障。
3. **性能（Performance）**：性能的评估取决于具体的工作负载。因此，必须先定义典型的工作负载，然后再评估 RAID 的性能表现。

接下来，我们将探讨 RAID 的几个重要设计：RAID 0 级（条带化）、RAID 1 级（镜像）和 RAID 4/5 级（基于奇偶校验的冗余），并对它们进行评估。

### 38.4 RAID 0 级：条带化

RAID 0 级，也称为条带化（striping），尽管没有提供任何冗余，但它在容量和性能方面表现出色，因此值得了解。

在 RAID 0 中，数据被条带化地分布在磁盘阵列中，如表 38.1 所示。数据块按轮转方式分布在磁盘上，目的是最大化并行性，特别是在处理顺序读取请求时。

可以通过调整大块大小（chunk size）来影响 RAID 的性能。例如，较小的大块大小增加了跨多个磁盘的并行性，但也可能增加定位时间。而较大的大块大小则减少了并行性，依赖于多个并发请求来实现高吞吐量。

RAID 0 在容量方面表现优异，N 个磁盘提供了 N 的有效容量。然而，由于缺乏冗余，RAID 0 的可靠性较差，任何一个磁盘的故障都会导致数据丢失。

在性能方面，RAID 0 通常表现很好，尤其是在顺序工作负载下，并行使用多个磁盘可以提供高吞吐量。稳态吞吐量取决于磁盘的数量和顺序或随机 I/O 的带宽（S 和 R）。顺序工作负载下，RAID 0 的带宽接近 N × S，而在随机工作负载下则为 N × R。

最后，计算单个请求的延迟时，RAID 0 的延迟与单个磁盘的延迟相当，而稳态吞吐量则会受到工作负载类型的显著影响。

### 38.5 RAID 1 级：镜像

RAID 1 级，即镜像（Mirroring），是超越条带化的第一个 RAID 级别。在镜像系统中，每个逻辑块都有多个副本，通常保留两个物理副本，分别存储在不同的磁盘上。这种冗余使得 RAID 1 能够容许单个磁盘的故障而不丢失数据。

在一个典型的 RAID 1 系统中，如表 38.3 所示，数据被镜像到不同的磁盘对上。例如，磁盘 0 和磁盘 1 存储相同的数据，磁盘 2 和磁盘 3 也存储相同的数据。读取操作可以从任意一个副本中进行，而写入操作则必须同时更新两个副本。写入可以并行进行，从而减少写入时间。

**RAID-1 分析：**

- **容量**：RAID 1 的有效容量仅为总容量的一半，因为每个块都有两个副本。因此，对于 N 个磁盘，RAID 1 提供的有效容量是 N/2。

- **可靠性**：RAID 1 的可靠性较高，能够容许至少一个磁盘故障，甚至可能容许多个磁盘故障，取决于具体的磁盘组合。

- 性能

  ：

  - **读取性能**：读取操作的延迟与单个磁盘相当，因为 RAID 1 可以选择从任意一个副本中读取数据。
  - **写入性能**：写入操作需要同时更新两个副本，因此逻辑写入操作的延迟略高于单个磁盘的写入延迟。
  - **稳态吞吐量**：顺序写入和读取的最大带宽都是峰值带宽的一半。对于随机读取，RAID 1 可以利用所有磁盘提供完整带宽，而随机写入的带宽则减半。

**一致更新问题**： RAID 1 及其他多磁盘 RAID 系统面临一致更新问题，即在执行多个磁盘的更新时，如何保证数据一致性。例如，如果在更新两个磁盘副本时发生掉电或崩溃，可能导致两个副本数据不一致。为了解决这个问题，通常会使用预写日志（write-ahead log）来确保在崩溃时可以恢复一致的状态。

**性能评估**： 在顺序工作负载下，RAID 1 的吞吐量是峰值带宽的一半，而在随机工作负载下，RAID 1 能够提供全部可用带宽。对于写入操作，顺序和随机的带宽都为总带宽的一半。RAID 1 提供的性能和可靠性平衡，使其成为一个非常可靠的存储解决方案。

### 38.6 RAID 4 级：通过奇偶校验节省空间

RAID 4 级使用了一种不同的冗余方法，即奇偶校验（parity），旨在通过减少冗余数据的存储量来节省空间，但这会对性能产生影响。

在 RAID 4 系统中，如表 38.4 所示，数据条带化存储在多个磁盘上，同时为每一条数据生成一个奇偶校验块，用于存储该条数据的冗余信息。例如，奇偶校验块 P1 包含由块 4、5、6 和 7 计算出的冗余信息。奇偶校验通过异或（XOR）操作计算，并用于在磁盘发生故障时重建丢失的数据。

#### 奇偶校验的工作原理

异或函数适用于每个数据位，保证在任何数据位丢失时，可以通过读取剩余数据位和奇偶校验位来重构丢失的数据。这种方法通过对每个块的每一位进行按位异或运算来实现。例如，块 0 和块 1 的每个位异或后生成一个奇偶校验位，该位存储在奇偶校验块中。

#### RAID-4 性能分析

RAID 4 的容量为 (N−1) 个磁盘的总容量，因为其中一个磁盘用于存储奇偶校验信息。可靠性方面，RAID 4 可以容许一个磁盘故障，但多个磁盘故障将导致数据不可恢复。

**性能分析**：

- **顺序读取**：RAID 4 可以并行读取所有数据磁盘，而不包括奇偶校验磁盘，因此顺序读取的最大带宽为 (N−1)·S MB/s。
- **顺序写入**：RAID 4 在顺序写入时可以通过“全条带写入”进行优化，即同时写入所有数据块和奇偶校验块，这使得顺序写入的最大带宽同样为 (N−1)·S MB/s。
- **随机读取**：随机读取性能与顺序读取相似，所有数据磁盘都可以并行读取，因此最大带宽为 (N−1)·R MB/s。
- **随机写入**：随机写入是 RAID 4 的性能瓶颈，因为它涉及对奇偶校验块的更新。为了正确更新奇偶校验，RAID 4 必须执行两次读取和两次写入，这导致奇偶校验磁盘成为瓶颈。小的随机写入性能通常为 (R/2) MB/s。

在 RAID 4 中，奇偶校验磁盘的负载过重，使得其成为整个系统性能的限制因素，这个问题被称为“小写入问题”。即使增加磁盘数量，也无法改善这种瓶颈。

**I/O 延迟**： 单次读取的延迟等同于单个磁盘请求的延迟。单次写入需要执行两次读取和两次写入，这些操作可以并行执行，因此总延迟大约是单个磁盘的两倍。然而，由于奇偶校验更新需要等待两次读取的完成，因此可能会导致更差的定位时间。

总体而言，RAID 4 在节省空间的同时，提供了可靠的数据保护，但在处理小的随机写入时表现不佳。

### 38.8 RAID 比较：总结

在本节中，对不同级别的 RAID 进行了比较，并总结了它们在容量、可靠性和性能上的差异。

- **RAID-0**：提供了最高的容量和性能，因为没有冗余，所以没有任何可靠性保障。所有磁盘的容量加在一起就是可用容量。吞吐量在顺序读写时最大，在随机 I/O 时性能也很好。
- **RAID-1**：通过镜像每个块来提供可靠性，但容量只有一半。它可以容忍一个磁盘的故障，但在随机写入时性能有所下降，因为需要写入两个副本。
- **RAID-4**：使用一个奇偶校验磁盘来提供冗余，因此容量为 (N-1)。它可以容忍一个磁盘故障，但在小的随机写入时性能很差，因为奇偶校验磁盘成为瓶颈。
- **RAID-5**：通过旋转奇偶校验块解决了 RAID-4 的小写入问题。容量和可靠性与 RAID-4 相同，但随机写入性能有所改善，因为奇偶校验块在不同的磁盘上轮转，减少了奇偶校验磁盘的负载。

表 38.10 总结了各个 RAID 级别的容量、可靠性和性能特点，帮助理解不同 RAID 设计之间的权衡。

### 38.9 其他有趣的 RAID 问题

本节提到了一些 RAID 设计中的其他有趣问题，例如其他 RAID 级别（如 RAID-2、RAID-3、RAID-6），以及在磁盘发生故障时系统的功能和性能表现。讨论了热备用磁盘的使用，以及在故障期间的性能变化。还提到了更复杂的故障模型，如潜在的扇区错误和块损坏，以及应对这些问题的技术。此外，还提到软件 RAID 的成本较低，但存在一致性更新问题。

### 38.10 小结

总结了 RAID 的概念及其在现代存储系统中的应用。RAID 将多个磁盘组合成一个更大且更可靠的存储系统，且对上层系统透明。不同的 RAID 级别适用于不同的需求，如 RAID-1 提供了良好的性能和可靠性，但容量成本高；RAID-5 则在容量和可靠性上更具优势，但在小写入场景下性能较差。选择合适的 RAID 级别并正确配置参数对优化性能和容量至关重要。